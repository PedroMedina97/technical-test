<div class="container-fluid p-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
          <i class="bi bi-person-plus me-2" *ngIf="!isEditMode"></i>
          <i class="bi bi-person-gear me-2" *ngIf="isEditMode"></i>
          {{ isEditMode ? 'Editar Usuario' : 'Crear Usuario' }}
        </h1>
        <button 
          type="button" 
          class="btn btn-outline-secondary"
          (click)="cancel()"
        >
          <i class="bi bi-arrow-left me-1"></i>
          Volver
        </button>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando usuario...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos del usuario...</p>
      </div>

      <!-- Form -->
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-person me-2"></i>
              Información Personal
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="name" class="form-label">
                  <i class="bi bi-person me-1"></i>
                  Nombre Completo *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="name"
                  formControlName="name"
                  [class.is-invalid]="isFieldInvalid('name')"
                  placeholder="Ingresa el nombre completo"
                  (blur)="formatTitleCase($event, 'name')"
                >
                <div *ngIf="isFieldInvalid('name')" class="invalid-feedback">
                  {{ getFieldError('name') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="username" class="form-label">
                  <i class="bi bi-at me-1"></i>
                  Nombre de Usuario *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="username"
                  formControlName="username"
                  [class.is-invalid]="isFieldInvalid('username')"
                  placeholder="Ingresa el nombre de usuario"
                >
                <div *ngIf="isFieldInvalid('username')" class="invalid-feedback">
                  {{ getFieldError('username') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">
                  <i class="bi bi-envelope me-1"></i>
                  Email *
                </label>
                <input 
                  type="email" 
                  class="form-control" 
                  id="email"
                  formControlName="email"
                  [class.is-invalid]="isFieldInvalid('email')"
                  placeholder="Ingresa el email"
                >
                <div *ngIf="isFieldInvalid('email')" class="invalid-feedback">
                  {{ getFieldError('email') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">
                  <i class="bi bi-telephone me-1"></i>
                  Teléfono *
                </label>
                <input 
                  type="tel" 
                  class="form-control" 
                  id="phone"
                  formControlName="phone"
                  [class.is-invalid]="isFieldInvalid('phone')"
                  placeholder="Ej: +1 (555) 123-4567 o 555#123"
                  maxlength="20"
                  minlength="10"
                  (input)="onPhoneInput($event)"
                  (keypress)="onPhoneKeyPress($event)"
                >
                <div *ngIf="isFieldInvalid('phone')" class="invalid-feedback">
                  {{ getFieldError('phone') }}
                </div>
                <div class="form-text">
                  <i class="bi bi-info-circle me-1"></i>
                  Solo se permiten números (0-9), +, #, espacios, guiones (-) y paréntesis ()
                </div>
              </div>
              <div class="col-12">
                <label for="website" class="form-label">
                  <i class="bi bi-globe me-1"></i>
                  Sitio Web *
                </label>
                <input 
                  type="url" 
                  class="form-control" 
                  id="website"
                  formControlName="website"
                  [class.is-invalid]="isFieldInvalid('website')"
                  placeholder="Ingresa el sitio web"
                >
                <div *ngIf="isFieldInvalid('website')" class="invalid-feedback">
                  {{ getFieldError('website') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Address Information -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-geo-alt me-2"></i>
              Información de Dirección
            </h5>
          </div>
          <div class="card-body" formGroupName="address">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="street" class="form-label">
                  <i class="bi bi-signpost me-1"></i>
                  Calle *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="street"
                  formControlName="street"
                  [class.is-invalid]="isNestedFieldInvalid('address', 'street')"
                  placeholder="Ingresa la calle"
                  (blur)="formatAddressField($event, 'address', 'street')"
                >
                <div *ngIf="isNestedFieldInvalid('address', 'street')" class="invalid-feedback">
                  {{ getNestedFieldError('address', 'street') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="suite" class="form-label">
                  <i class="bi bi-building me-1"></i>
                  Suite/Apartamento *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="suite"
                  formControlName="suite"
                  [class.is-invalid]="isNestedFieldInvalid('address', 'suite')"
                  placeholder="Ingresa la suite o apartamento"
                >
                <div *ngIf="isNestedFieldInvalid('address', 'suite')" class="invalid-feedback">
                  {{ getNestedFieldError('address', 'suite') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="city" class="form-label">
                  <i class="bi bi-geo me-1"></i>
                  Ciudad *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="city"
                  formControlName="city"
                  [class.is-invalid]="isNestedFieldInvalid('address', 'city')"
                  placeholder="Ingresa la ciudad"
                  (blur)="formatAddressField($event, 'address', 'city')"
                >
                <div *ngIf="isNestedFieldInvalid('address', 'city')" class="invalid-feedback">
                  {{ getNestedFieldError('address', 'city') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="zipcode" class="form-label">
                  <i class="bi bi-mailbox me-1"></i>
                  Código Postal *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="zipcode"
                  formControlName="zipcode"
                  [class.is-invalid]="isNestedFieldInvalid('address', 'zipcode')"
                  placeholder="Ingresa el código postal"
                >
                <div *ngIf="isNestedFieldInvalid('address', 'zipcode')" class="invalid-feedback">
                  {{ getNestedFieldError('address', 'zipcode') }}
                </div>
              </div>
            </div>

            <!-- Coordinates -->
            <div class="row g-3 mt-3" formGroupName="geo">
              <div class="col-12">
                <h6 class="text-muted mb-3">
                  <i class="bi bi-geo-alt-fill me-2"></i>
                  Coordenadas Geográficas
                </h6>
              </div>
              <div class="col-md-6">
                <label for="lat" class="form-label">
                  <i class="bi bi-latitude me-1"></i>
                  Latitud *
                </label>
                <input 
                  type="number" 
                  step="any"
                  class="form-control" 
                  id="lat"
                  formControlName="lat"
                  [class.is-invalid]="isDeepFieldInvalid('address', 'geo', 'lat')"
                  placeholder="Ej: -37.3159"
                >
                <div *ngIf="isDeepFieldInvalid('address', 'geo', 'lat')" class="invalid-feedback">
                  {{ getDeepFieldError('address', 'geo', 'lat') }}
                </div>
              </div>
              <div class="col-md-6">
                <label for="lng" class="form-label">
                  <i class="bi bi-longitude me-1"></i>
                  Longitud *
                </label>
                <input 
                  type="number" 
                  step="any"
                  class="form-control" 
                  id="lng"
                  formControlName="lng"
                  [class.is-invalid]="isDeepFieldInvalid('address', 'geo', 'lng')"
                  placeholder="Ej: 81.1496"
                >
                <div *ngIf="isDeepFieldInvalid('address', 'geo', 'lng')" class="invalid-feedback">
                  {{ getDeepFieldError('address', 'geo', 'lng') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Company Information -->
        <div class="card mt-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="bi bi-building me-2"></i>
              Información de la Empresa
            </h5>
          </div>
          <div class="card-body" formGroupName="company">
            <div class="row g-3">
              <div class="col-12">
                <label for="companyName" class="form-label">
                  <i class="bi bi-building me-1"></i>
                  Nombre de la Empresa *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="companyName"
                  formControlName="name"
                  [class.is-invalid]="isNestedFieldInvalid('company', 'name')"
                  placeholder="Ingresa el nombre de la empresa"
                  (blur)="formatCompanyName($event)"
                >
                <div *ngIf="isNestedFieldInvalid('company', 'name')" class="invalid-feedback">
                  {{ getNestedFieldError('company', 'name') }}
                </div>
              </div>
              <div class="col-12">
                <label for="catchPhrase" class="form-label">
                  <i class="bi bi-quote me-1"></i>
                  Eslogan *
                </label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="catchPhrase"
                  formControlName="catchPhrase"
                  [class.is-invalid]="isNestedFieldInvalid('company', 'catchPhrase')"
                  placeholder="Ingresa el eslogan de la empresa"
                >
                <div *ngIf="isNestedFieldInvalid('company', 'catchPhrase')" class="invalid-feedback">
                  {{ getNestedFieldError('company', 'catchPhrase') }}
                </div>
              </div>
              <div class="col-12">
                <label for="bs" class="form-label">
                  <i class="bi bi-info-circle me-1"></i>
                  Descripción del Negocio *
                </label>
                <textarea 
                  class="form-control" 
                  id="bs"
                  formControlName="bs"
                  [class.is-invalid]="isNestedFieldInvalid('company', 'bs')"
                  placeholder="Ingresa la descripción del negocio"
                  rows="3"
                ></textarea>
                <div *ngIf="isNestedFieldInvalid('company', 'bs')" class="invalid-feedback">
                  {{ getNestedFieldError('company', 'bs') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="card mt-4">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <button 
                type="button" 
                class="btn btn-outline-secondary btn-lg"
                (click)="cancel()"
                [disabled]="isSaving"
              >
                <i class="bi bi-x-circle me-2"></i>
                Cancelar
              </button>
              <button 
                type="submit" 
                class="btn btn-primary btn-lg"
                [disabled]="isSaving || userForm.invalid"
              >
                <span *ngIf="isSaving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <i *ngIf="!isSaving" class="bi bi-check-circle me-2"></i>
                {{ isSaving ? 'Guardando...' : (isEditMode ? 'Actualizar Usuario' : 'Crear Usuario') }}
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
